FROM ubuntu:24.04

ARG DEBIAN_FRONTEND=noninteractive
ARG USERNAME=dev
ARG USER_UID=1000
ARG USER_GID=1000
ARG FLUTTER_CHANNEL=stable
ARG GO_VERSION=1.25.5
ARG TARGETARCH

# Base tools
RUN apt-get update && apt-get install -y --no-install-recommends \
  git curl ca-certificates unzip xz-utils zip bash make jq \
  build-essential pkg-config clang cmake ninja-build ripgrep \
  libgtk-3-dev libblkid-dev liblzma-dev libstdc++-12-dev \
  && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN set -eux; \
  if getent group ${USER_GID} >/dev/null; then \
    EXISTING_GROUP="$(getent group ${USER_GID} | cut -d: -f1)"; \
    echo "Using existing group $EXISTING_GROUP for GID ${USER_GID}"; \
    group_name="$EXISTING_GROUP"; \
  else \
    groupadd --gid ${USER_GID} ${USERNAME}; \
    group_name="${USERNAME}"; \
  fi; \
  useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME}; \
  mkdir -p /workspace; \
  chown -R ${USERNAME}:${group_name} /workspace

# Install Flutter SDK
RUN git clone https://github.com/flutter/flutter.git /opt/flutter --branch ${FLUTTER_CHANNEL} --depth 1 \
  && chown -R ${USER_UID}:${USER_GID} /opt/flutter
ENV PATH="/opt/flutter/bin:/opt/flutter/bin/cache/dart-sdk/bin:${PATH}"

# Install Go (potentially change this to multi-arch Go install for fully native arm64 container)
RUN set -eux; \
  arch="${TARGETARCH:-amd64}"; \
  case "$arch" in \
    amd64|arm64) ;; \
    *) echo "Unsupported TARGETARCH=$arch" >&2; exit 1 ;; \
  esac; \
  curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-${arch}.tar.gz" -o /tmp/go.tgz; \
  rm -rf /usr/local/go; \
  tar -C /usr/local -xzf /tmp/go.tgz; \
  rm /tmp/go.tgz
ENV PATH="/usr/local/go/bin:${PATH}"

ENV GOPATH="/home/${USERNAME}/go"
ENV GOMODCACHE="/home/${USERNAME}/go/pkg/mod"
ENV GOCACHE="/home/${USERNAME}/.cache/go-build"
ENV PATH="${GOPATH}/bin:${PATH}"

RUN git config --system --add safe.directory /workspace

USER ${USERNAME}
WORKDIR /workspace

# Warm up
RUN flutter --version && dart --version && go version
